
name: Build components

on:
  push:

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-centos7:
    secrets: inherit
    uses: intel-innersource/libraries.devops.renderkit.workflows/.github/workflows/docker_gpu.yml@main
    with:
      image: centos:7
      env-from-files: ./env/dpcpp-none.env
      level-zero-version: public/1.9.4
      install-gfx-driver: false
      cmd: |
        module load cmake/3.25.1
        module load intel/2023.0
        export CC=icx
        export CXX=icpx
        export CXXFLAGS="-fhonor-infinities -fhonor-nans"
        export LDFLAGS="-static-intel"
        scl enable devtoolset-7 'cmake -L -S . -B build -DCMAKE_INSTALL_PREFIX=install -DOSPRAY_ENABLE_MODULE_MPI=OFF'
        scl enable devtoolset-7 'cmake --build build --config Release'

  build-ubuntu2004:
    secrets: inherit
    uses: intel-innersource/libraries.devops.renderkit.workflows/.github/workflows/docker_gpu.yml@main
    with:
      image: ubuntu:20.04
      env-from-files: ./env/dpcpp-none.env
      level-zero-version: public/1.9.4
      install-gfx-driver: false
      cmd: |
        module load cmake/3.25.1
        module load intel/2023.0
        export CC=icx
        export CXX=icpx
        export CXXFLAGS="-fhonor-infinities -fhonor-nans"
        export LDFLAGS="-static-intel"
        cmake -L -S . -B build -DCMAKE_INSTALL_PREFIX=install -DOSPRAY_ENABLE_MODULE_MPI=OFF
        cmake --build build --config Release
      artifact-path: build install
      artifact-out: build-ubuntu2004
      artifact-on-failure: true

  build-ubuntu2204:
    secrets: inherit
    uses: intel-innersource/libraries.devops.renderkit.workflows/.github/workflows/docker_gpu.yml@main
    with:
      image: ubuntu:22.04
      env-from-files: ./env/dpcpp-none.env
      level-zero-version: public/1.9.4
      install-gfx-driver: false
      cmd: |
        module load cmake/3.25.1
        module load intel/2023.0
        export CC=icx
        export CXX=icpx
        export CXXFLAGS="-fhonor-infinities -fhonor-nans"
        export LDFLAGS="-static-intel"
        cmake -L -S . -B build -DCMAKE_INSTALL_PREFIX=install -DOSPRAY_ENABLE_MODULE_MPI=OFF
        cmake --build build --config Release

  build-macos:
    uses: intel-innersource/libraries.devops.renderkit.workflows/.github/workflows/macos.yml@main
    with:
      cmd: |
        export CXXFLAGS='-stdlib=libc++'
        export MACOSX_DEPLOYMENT_TARGET=11.0
        mkdir build
        cmake -L -S . -B build -DCMAKE_INSTALL_PREFIX=install
        cmake --build build --config Release

  build-windows:
    secrets: inherit
    uses: intel-innersource/libraries.devops.renderkit.workflows/.github/workflows/windows_gpu.yml@main
    with:
      env-from-files: ./env/dpcpp-none.env
      level-zero-version: public/1.9.4
      install-gfx-driver: false
      cmd: |
        call "C:\Program Files (x86)\Intel\oneAPI\compiler\latest\env\vars.bat"
        set CXX=icx.exe
        set CC=icx.exe
        cmake -L -S . -B build -DCMAKE_INSTALL_PREFIX=install -DOSPRAY_ENABLE_MODULE_MPI=OFF -G Ninja
        cmake --build build --config Release
      shell: cmd

